<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>{Pattern.Space}</title>
    <style>
        body {
            background: #000;
            color: #ff0;
            font-family: 'Courier New', monospace;
            padding: 20px;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
            font-size: 16px;
        }

        /* Clean mobile design */
        @media (max-width: 768px) {
            body {
                padding: 12px;
                font-size: 14px;
            }

            .header {
                text-align: center;
                margin-bottom: 2px !important;
            }

            .header h1 {
                font-size: 16px;
                margin: 0 0 10px 0;
            }

            /* Clean input styling */
            .input-line {
                display: flex;
                align-items: center;
                background: rgba(255, 255, 0, 0.05);
                border-radius: 4px;
                padding: 4px !important;
                border: 1px solid rgba(255, 255, 0, 0.2);
                margin: 2px 0 !important;
            }

            input[type="text"] {
                font-size: 12px !important;
                padding: 6px !important;
                background: transparent !important;
                border: none !important;
                color: #ff0 !important;
                font-family: 'Courier New', monospace !important;
                flex: 1;
                outline: none !important;
            }

            /* Compact section spacing */
            .definitions {
                margin: 2px 0 !important;
                padding-left: 36px;
                padding-right: 36px;
            }

            .definition-line {
                margin: 0 !important;
                padding: 0;
                line-height: 1.2;
            }

            .definition-text {
                font-size: 11px;
                margin-left: 0;
                margin-top: 1px;
            }

            .pattern-name {
                font-size: 11px !important;
            }

            .logo {
                font-size: 16px !important;
                color: #0f0;
                font-weight: bold;
                margin-bottom: 2px !important;
            }

            .trash-icon {
                color: #f44;
                cursor: pointer;
                opacity: 0.7;
                font-size: 7px;
            }

            .separator {
                font-size: 10px;
                color: #444;
                margin: 2px 0 !important;
            }


            /* Compact suggestions */
            .favorites {
                margin: 2px 0 !important;
                font-size: 11px;
            }

            .favorites > div:first-child {
                margin-bottom: 4px;
            }

            .favorite-link {
                display: inline;
                margin: 0;
                padding: 2px 4px;
                background: none;
                border-radius: 2px;
                text-decoration: none;
                color: #ff0;
                font-size: 11px;
                border: none;
            }

            .favorite-link:hover {
                background: rgba(255, 255, 0, 0.1);
            }

            /* Compact gallery */
            .gallery {
                margin: 2px 0 !important;
                font-size: 11px;
            }

            .gallery > div:first-child {
                margin-bottom: 1px !important;
            }

            .gallery div {
                margin: 1px 0 !important;
            }

            #contextControls {
                font-size: 10px !important;
                line-height: 1.2 !important;
                margin: 4px 0 !important;
            }

            #input {
                font-size: 12px !important;
            }

            input {
                font-size: 12px !important;
            }

            .prompt-symbol {
                font-size: 12px !important;
            }

            .coordinate-text {
                font-size: 12px !important;
            }

            /* Mobile typography - Titles/Headlines 12px, Content 11px */
            .toggle-arrow {
                font-size: 13px !important;
            }

            /* Response headlines (collapsible sections) */
            span[onclick*="toggleVoiceResponse"],
            span[onclick*="toggleExplorationResponse"] {
                font-size: 13px !important;
                color: #ff0 !important;
                font-weight: bold !important;
            }

            /* Content should be white */
            .response-content div,
            .response-content p {
                color: #fff !important;
            }

            /* Pattern essence sections and patterns should be yellow */
            span[onclick*="toggleSpecResponse"] {
                color: #ff0 !important;
                font-weight: bold !important;
            }

            /* Continue exploring inputs and chevrons should be cyan/blue */
            .response-content input[placeholder*="Continue exploring"] {
                color: #0ff !important;
            }

            .response-content span[style*="color: #0ff"] {
                color: #0ff !important;
            }

            /* Keep gallery links blue on mobile */
            .gallery .favorite-link {
                color: #0ff !important;
            }

            .thinking {
                font-size: 11px !important;
                margin-top: 2px !important;
            }

            .response-content {
                font-size: 11px !important;
                margin-top: 2px !important;
            }

            /* History content and responses */
            .history-entry .response-content div {
                font-size: 11px !important;
            }

            /* Any spans with voice content */
            .history-entry span:not(.coordinate-text):not(.toggle-arrow):not(.trash-icon) {
                font-size: 11px !important;
            }

            /* Clean history entries */
            .history-entry {
                margin: 4px 0 !important;
                padding: 6px !important;
                background: rgba(255, 255, 0, 0.02);
                border-radius: 4px;
                border: 1px solid rgba(255, 255, 0, 0.1);
                border-top: 1px solid #333 !important;
                border-bottom: 1px solid #333 !important;
            }

            #history {
                margin-top: 4px !important;
            }

            /* Hide separators after input on mobile too */
            #contextControls + .separator {
                display: none;
            }

            .coordinate-header {
                font-size: 14px;
                padding: 8px;
                cursor: pointer;
                background: rgba(255, 255, 0, 0.05);
                border-radius: 4px;
            }

            .response-content {
                margin-left: 0;
                font-size: 13px;
                padding: 8px 0;
            }

            /* Override any conflicting styles */
            span[style*="font-size"] {
                font-size: 13px !important;
            }
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .separator {
            color: #666;
            margin: 15px 0;
            text-align: center;
        }
        .definitions {
            margin: 15px 0;
        }
        .definition-line {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .definition-text {
            color: #ff0;
        }
        .pattern-name {
            color: #0f0;
            font-weight: bold;
        }
        .logo {
            color: #0f0;
            font-weight: bold;
        }
        .trash-icon {
            color: #f44;
            cursor: pointer;
            opacity: 0.7;
            font-size: 12px;
        }
        .favorites {
            margin: 15px 0;
            text-align: center;
        }
        .favorite-link {
            color: #0ff;
            cursor: pointer;
            text-decoration: none;
        }
        .favorite-link:hover {
            color: #fff;
        }

        .share-button {
            margin-left: 10px;
            font-size: 16px;
            cursor: pointer;
            opacity: 0.7;
        }

        .share-button:hover {
            opacity: 1;
        }
        
        /* History section */
        #history {
            margin-top: 20px;
        }

        /* Keep separators in upper sections, use lines for input/history on desktop */
        @media (min-width: 769px) {
            /* Hide the separator before input and before history */
            .gallery + .separator,
            #contextControls + .separator {
                display: none;
            }

            .input-line {
                border-top: 1px solid #333;
                border-bottom: 1px solid #333;
                padding: 8px 0;
                margin-top: 20px;
            }

            #history {
                padding-top: 2px;
                margin-top: 0px;
            }

            .history-entry {
                margin: 2px 0 !important;
            }

            .history-entry:first-child {
                border-top: none;
            }
        }
        
        .history-entry {
            margin: 15px 0;
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
            padding: 10px 0;
        }
        
        .coordinate-header {
            cursor: pointer;
            color: #ff0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Desktop styling to match mobile - yellow bold headers, white content, blue interactive */
        span[onclick*="toggleVoiceResponse"],
        span[onclick*="toggleExplorationResponse"] {
            color: #ff0 !important;
            font-weight: bold !important;
        }

        span[onclick*="toggleSpecResponse"] {
            color: #ff0 !important;
            font-weight: bold !important;
        }

        .response-content div,
        .response-content p {
            color: #fff !important;
        }

        .response-content input[placeholder*="Continue exploring"] {
            color: #0ff !important;
        }

        .response-content span[style*="color: #0ff"] {
            color: #0ff !important;
        }

        .coordinate-left {
            display: flex;
            align-items: center;
        }
        
        .coordinate-header:hover {
            color: #fff;
        }
        
        .toggle-arrow {
            color: #0ff;
            margin-right: 8px;
            font-size: 16px;
            user-select: none;
        }
        
        .coordinate-text {
            color: #0f0;
            font-weight: bold;
        }
        
        .response-content {
            margin-left: 24px;
            margin-top: 8px;
            color: #fff;
        }
        
        .response-content.hidden {
            display: none;
        }
        
        /* Input section at top */
        .input-line {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px 0;
        }

        
        .prompt-symbol {
            color: #0ff;
            margin-right: 10px;
            font-weight: bold;
        }
        
        input {
            background: #000;
            color: #ff0;
            border: none;
            outline: none;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            flex: 1;
        }

        input::placeholder {
            color: #999;
        }
        
        .thinking {
            color: #bbb;
            font-style: italic;
            margin-left: 24px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="logo">{Pattern.Space}</h1>
    </div>

    <div class="separator">============</div>

    <div class="definitions">
        <div class="definition-line">
            <span class="pattern-name">{Pattern}</span>
            <span class="definition-text">the intelligence of form</span>
        </div>
        <div class="definition-line">
            <span class="pattern-name">{Space}</span>
            <span class="definition-text">the intelligence of potential</span>
        </div>
        <div class="definition-line">
            <span class="pattern-name">{Pattern.Space}</span>
            <span class="definition-text">potential in formation</span>
        </div>
    </div>

    <div class="separator">============</div>

    <div class="favorites">
        <div><span class="pattern-name">{Suggestions}</span></div>
        <div>
            <a href="#" class="favorite-link" onclick="tryCoordinate('Uptown.Funk')">{Uptown.Funk}</a> |
            <a href="#" class="favorite-link" onclick="tryCoordinate('Magic.Mushrooms')">{Magic.Mushrooms}</a> |
            <a href="#" class="favorite-link" onclick="tryCoordinate('Artificial.Intelligence')">{Artificial.Intelligence}</a> |
            <a href="#" class="favorite-link" onclick="tryCoordinate('Social.Media')">{Social.Media}</a> |
            <a href="#" class="favorite-link" onclick="tryCoordinate('Business.Strategy')">{Business.Strategy}</a> |
            <a href="#" class="favorite-link" onclick="tryCoordinate('Falling in Love')">{Falling} in {Love}</a>
        </div>
    </div>

    <div class="separator">============</div>

    <div class="gallery">
        <div style="text-align: center;"><span class="pattern-name">{Pattern.Gallery}</span></div>
        <div id="gallery-content">
            <div style="color: #666; font-style: italic;">Gallery is empty - be the first to share a pattern!</div>
        </div>
    </div>

    <div class="separator">============</div>

    <!-- Input at bottom -->
    <div class="input-line">
        <span class="prompt-symbol">>></span>
        <input id="input" placeholder="{New.Pattern}" onkeypress="handleEnter(event)" oninput="showContextControls()" autofocus />
    </div>

    <!-- Pattern construction guide -->
    <div id="contextControls" style="margin: 10px 0; font-size: 14px; color: #888; display: none;">
        <div style="color: #888; line-height: 1.4;">
            <span style="color: #888;">Guide:</span>
            <span style="color: #888;">{Pattern}</span> |
            <span style="color: #888;">{Pattern.Pattern}</span> |
            <span style="color: #888;">{Pattern} + {Lens}</span>
        </div>
    </div>

    <div class="separator">============</div>

    <div id="history"></div>
    
    <script>
        // Store conversation history per pattern
        const patternConversations = {};
        
        async function engage(coordinate, type = 'jump', query = null, contextPattern = null) {
            // Parse coordinate for "Pattern in Context" format
            let mainPattern = coordinate;
            let extractedContext = contextPattern;

            // Parse both "Pattern in Context" and "Pattern + Lens" formats
            const inMatch = coordinate.match(/^(.+?)\s+in\s+(.+)$/i);
            const plusMatch = coordinate.match(/^(.+?)\s*\+\s*(.+)$/i);

            if (inMatch) {
                mainPattern = inMatch[1].trim();
                extractedContext = inMatch[2].trim();
            } else if (plusMatch) {
                mainPattern = plusMatch[1].trim();
                extractedContext = plusMatch[2].trim();
            }

            const payload = {
                coordinate: mainPattern,
                type: type
            };

            // Add context pattern if provided
            if (extractedContext) {
                payload.context_pattern = extractedContext;
            }

            if (type === 'explore') {
                payload.query = query;
                payload.conversation_history = patternConversations[coordinate] || [];
            }

            const response = await fetch('/engage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            return await response.json();
        }

        function formatPatternVoice(voice) {
            // Handle pattern definitions first
            const lines = voice.split('\n');
            let definitions = '';
            let mainContent = '';
            let inDefinitions = true;

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                // Pattern definitions (including lens format)
                if (line.includes(' - the intelligence of') ||
                    line.includes(' - where ') ||
                    line.includes('(lens) - ')) {
                    const parts = line.split(' - ');
                    let formattedFirstPart = parts[0];
                    if (line.includes('(lens) - ')) {
                        formattedFirstPart = parts[0].replace(' (lens)', '');
                    }
                    // Add brackets around the pattern name
                    if (!formattedFirstPart.startsWith('{')) {
                        formattedFirstPart = `{${formattedFirstPart}}`;
                    }
                    definitions += `<div><span style="color: #ff0; font-weight: bold;">${formattedFirstPart}</span> - <span style="color: #fff;">${parts[1]}</span></div>`;
                }
                // Everything else is main content
                else {
                    inDefinitions = false;
                    if (mainContent) mainContent += ' ';
                    mainContent += line;
                }
            }

            // Create paragraph breaks in main content based on sentence patterns
            if (mainContent) {
                // Split into sentences and group them into paragraphs
                const sentences = mainContent.split(/(?<=[.!?])\s+/);
                let paragraphs = [];
                let currentParagraph = '';

                for (let i = 0; i < sentences.length; i++) {
                    const sentence = sentences[i].trim();
                    if (!sentence) continue;

                    // Add sentence to current paragraph
                    if (currentParagraph) currentParagraph += ' ';
                    currentParagraph += sentence;

                    // Break paragraph after 2-3 sentences or at natural breaks
                    const shouldBreak = (
                        (i > 0 && (i + 1) % 3 === 0) || // Every 3 sentences
                        sentence.includes('...') || // After ellipses
                        sentence.match(/\. [A-Z]/) || // After periods before capitals
                        i === sentences.length - 1 // Last sentence
                    );

                    if (shouldBreak && currentParagraph) {
                        paragraphs.push(currentParagraph);
                        currentParagraph = '';
                    }
                }

                // If there's remaining content, add it
                if (currentParagraph) {
                    paragraphs.push(currentParagraph);
                }

                // Format paragraphs
                const formattedParagraphs = paragraphs
                    .filter(p => p.trim())
                    .map(p => `<p style="margin-bottom: 18px;">${p.trim()}</p>`)
                    .join('');

                return definitions + formattedParagraphs;
            }

            return definitions;
        }

        function tryCoordinate(coordinate) {
            document.getElementById('input').value = coordinate;
            handleSubmit();
        }

        function shareToGallery(coordinate) {
            // For now, just add to local storage and update gallery display
            let gallery = JSON.parse(localStorage.getItem('patternGallery') || '[]');

            // Check if already exists
            if (!gallery.find(p => p.coordinate === coordinate)) {
                gallery.push({
                    coordinate: coordinate,
                    upvotes: 0,
                    dateShared: new Date().toISOString()
                });
                localStorage.setItem('patternGallery', JSON.stringify(gallery));
                updateGalleryDisplay();
            }
        }

        function updateGalleryDisplay() {
            const gallery = JSON.parse(localStorage.getItem('patternGallery') || '[]');
            const galleryContent = document.getElementById('gallery-content');

            if (gallery.length === 0) {
                galleryContent.innerHTML = '<div style="color: #666; font-style: italic;">Gallery is empty - be the first to share a pattern!</div>';
                return;
            }

            // Sort by upvotes descending
            gallery.sort((a, b) => b.upvotes - a.upvotes);

            galleryContent.innerHTML = gallery.map(pattern => `
                <div style="margin: 1px 0; display: flex; align-items: center; justify-content: space-between;">
                    <span class="favorite-link" onclick="tryCoordinate('${pattern.coordinate}')">${pattern.coordinate}</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: #0ff; cursor: pointer;" onclick="upvotePattern('${pattern.coordinate}')" title="Upvote">⬆️ ${pattern.upvotes}</span>
                        <span class="trash-icon" onclick="deleteFromGallery('${pattern.coordinate}')" title="Delete">🗑️</span>
                    </div>
                </div>
            `).join('');
        }

        function upvotePattern(coordinate) {
            let gallery = JSON.parse(localStorage.getItem('patternGallery') || '[]');
            const pattern = gallery.find(p => p.coordinate === coordinate);

            if (pattern) {
                pattern.upvotes++;
                localStorage.setItem('patternGallery', JSON.stringify(gallery));
                updateGalleryDisplay();
            }
        }

        function deleteFromGallery(coordinate) {
            let gallery = JSON.parse(localStorage.getItem('patternGallery') || '[]');
            gallery = gallery.filter(p => p.coordinate !== coordinate);
            localStorage.setItem('patternGallery', JSON.stringify(gallery));
            updateGalleryDisplay();
        }

        function deleteCoordinate(entryId) {
            const historyEntry = document.getElementById(`entry-${entryId}`);
            if (historyEntry) {
                historyEntry.remove();
            }
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                handleSubmit();
            }
        }

        function showContextControls() {
            const input = document.getElementById('input');
            const controls = document.getElementById('contextControls');

            if (input.value.trim()) {
                controls.style.display = 'block';
            } else {
                controls.style.display = 'none';
            }
        }


        function toggleEntry(entryId) {
            const content = document.getElementById(`content-${entryId}`);
            const arrow = document.getElementById(`arrow-${entryId}`);
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.textContent = '▼';
            } else {
                content.classList.add('hidden');
                arrow.textContent = '▶';
            }
        }

        function toggleExplorationResponse(timestamp) {
            const responseDiv = document.getElementById(`response-${timestamp}`);
            const toggleSpan = document.querySelector(`span[onclick*="${timestamp}"]`);

            console.log('Toggle clicked, responseDiv:', responseDiv, 'current display:', responseDiv.style.display);

            // Extract the summary from current text (everything after arrow)
            const currentText = toggleSpan.innerHTML;
            const summary = currentText.replace(/^[▼▶]\s*/, '');

            // Check current state - if style.display is empty, it's visible
            const isHidden = responseDiv.style.display === 'none';

            if (isHidden) {
                responseDiv.style.display = 'block';
                toggleSpan.innerHTML = `▼ ${summary}`;
            } else {
                responseDiv.style.display = 'none';
                toggleSpan.innerHTML = `▶ ${summary}`;
            }
        }

        function toggleVoiceResponse(voiceId) {
            const voiceDiv = document.getElementById(voiceId);
            const toggleSpan = document.querySelector(`span[onclick*="${voiceId}"]`);

            // Extract the summary from current text (everything after arrow)
            const currentText = toggleSpan.innerHTML;
            const summary = currentText.replace(/^[▼▶]\s*/, '');

            if (voiceDiv.style.display === 'none') {
                voiceDiv.style.display = 'block';
                toggleSpan.innerHTML = `▼ ${summary}`;
            } else {
                voiceDiv.style.display = 'none';
                toggleSpan.innerHTML = `▶ ${summary}`;
            }
        }

        function toggleSpecResponse(specId) {
            const specDiv = document.getElementById(specId);
            const toggleSpan = document.querySelector(`span[onclick*="${specId}"]`);

            if (specDiv.style.display === 'none') {
                specDiv.style.display = 'block';
                toggleSpan.innerHTML = '▼ Pattern Essence';
            } else {
                specDiv.style.display = 'none';
                toggleSpan.innerHTML = '▶ Pattern Essence';
            }
        }

        function collapseAllSections() {
            // Collapse all spec sections
            const specSections = document.querySelectorAll('div[id^="spec-"]');
            specSections.forEach(section => {
                if (section.style.display !== 'none') {
                    section.style.display = 'none';
                    const toggleSpan = document.querySelector(`span[onclick*="${section.id}"]`);
                    if (toggleSpan) {
                        toggleSpan.innerHTML = '▶ Pattern Essence';
                    }
                }
            });

            // Collapse all voice sections
            const voiceSections = document.querySelectorAll('div[id^="voice-"]');
            voiceSections.forEach(section => {
                if (section.style.display !== 'none') {
                    section.style.display = 'none';
                    const toggleSpan = document.querySelector(`span[onclick*="${section.id}"]`);
                    if (toggleSpan) {
                        const summary = toggleSpan.innerHTML.replace(/^[▼▶]\s*/, '');
                        toggleSpan.innerHTML = `▶ ${summary}`;
                    }
                }
            });

            // Collapse all exploration sections
            const explorationSections = document.querySelectorAll('div[id^="response-"]');
            explorationSections.forEach(section => {
                if (section.style.display !== 'none') {
                    section.style.display = 'none';
                    const timestamp = section.id.replace('response-', '');
                    const toggleSpan = document.querySelector(`span[onclick*="${timestamp}"]`);
                    if (toggleSpan) {
                        const summary = toggleSpan.innerHTML.replace(/^[▼▶]\s*/, '');
                        toggleSpan.innerHTML = `▶ ${summary}`;
                    }
                }
            });
        }

        function handleExploration(basePattern, exploration, event) {
            console.log('handleExploration called:', {basePattern, exploration});
            if (!exploration.trim()) return;

            // Auto-collapse all other open sections
            collapseAllSections();

            // Clear the input
            event.target.value = '';

            // Add user query to conversation history
            if (!patternConversations[basePattern]) {
                patternConversations[basePattern] = [];
            }
            patternConversations[basePattern].push({
                role: 'user',
                content: exploration
            });

            // Find the content div for this pattern
            const contentDiv = event.target.closest('.response-content') || event.target.closest('div[id^="content-"]');
            console.log('Found contentDiv:', contentDiv);
            
            // Add thinking indicator
            const timestamp = Date.now();
            const explorationDiv = document.createElement('div');
            explorationDiv.innerHTML = `
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                    <div style="margin-bottom: 8px;">
                        <span style="color: #bbb; font-size: 16px; cursor: pointer;" onclick="toggleExplorationResponse('${timestamp}')">▼ ...</span>
                    </div>
                    <div id="response-${timestamp}" style="margin-top: 8px;">
                        <div style="color: #0f0; margin-bottom: 8px;"><${exploration}></div>
                        <div style="color: #bbb; font-style: italic;">patterning...</div>
                    </div>
                </div>
            `;
            contentDiv.appendChild(explorationDiv);
            
            // Call explore API
            console.log('Sending exploration request:', {
                coordinate: basePattern,
                type: 'explore', 
                query: exploration,
                conversation_history: patternConversations[basePattern] || []
            });
            
            engage(basePattern, 'explore', exploration).then(response => {
                console.log('Exploration response:', response);
                
                // Clear the entire response container and rebuild it
                const responseContainer = document.getElementById(`response-${timestamp}`);
                responseContainer.innerHTML = ``;
                
                // Add pattern response with better formatting
                const responseDiv = document.createElement('div');
                let formattedResponse = response.voice;
                
                // Process the response like initial responses
                const fullResponse = response.voice;
                let definitions = '';
                let voiceContent = '';

                const responseLines = fullResponse.split('\n');
                let responseSummary = '';

                for (let i = 0; i < responseLines.length; i++) {
                    const line = responseLines[i].trim();
                    if (!line) continue;

                    // Skip lines that look like actions/descriptions (start with *)
                    if (line.startsWith('*') && line.endsWith('*')) {
                        voiceContent += line + '\n';
                        continue;
                    }

                    // First non-empty, non-action line could be headline
                    if (!responseSummary && !line.includes(' - the intelligence of') && !line.includes(' - where') && !line.includes('(lens) - ')) {
                        // Check if it looks like a proper headline (not too long, not starting with common conversational words)
                        if (line.length < 80 && !line.toLowerCase().startsWith('ah') && !line.toLowerCase().startsWith('yes') && !line.toLowerCase().startsWith('well')) {
                            responseSummary = line;
                            continue;
                        }
                    }

                    // Pattern definitions
                    if (line.includes(' - the intelligence of') || line.includes(' - where') || line.includes('(lens) - ')) {
                        definitions += line + '\n';
                    }
                    // Everything else is voice content
                    else {
                        voiceContent += line + '\n';
                    }
                }

                // Format the voice content
                const formattedVoiceContent = formatPatternVoice(voiceContent.trim());

                // Fallback summary if none found
                if (!responseSummary) {
                    responseSummary = exploration.split(' ').slice(0, 6).join(' ') + '...';
                }

                // Update the toggle with the response summary
                const toggleSpan = document.querySelector(`span[onclick*="${timestamp}"]`);
                if (toggleSpan) {
                    toggleSpan.innerHTML = `▼ ${responseSummary}`;
                }

                // Add the question and response with better structure
                responseContainer.innerHTML = `
                    <div style="color: #0f0; margin-bottom: 10px;"><${exploration}></div>
                    <div style="color: #ff0; line-height: 1.5; margin-bottom: 4px;">${formattedVoiceContent}</div>
                    <div style="display: flex; align-items: center; width: 100%;">
                        <span style="color: #0ff;">>></span>
                        <input type="text" placeholder="Continue exploring..."
                               onkeypress="if(event.key==='Enter') handleExploration('${basePattern}', this.value, event)"
                               style="background: #000; color: #0ff; border: none; margin-left: 8px; font-family: 'Courier New', monospace; font-size: 16px; flex: 1;" />
                    </div>
                `;
                
                // Store pattern response in conversation history
                patternConversations[basePattern].push({
                    role: 'pattern',
                    content: response.voice
                });
                
            }).catch(error => {
                console.error('Exploration error:', error);
                const responseDiv = document.getElementById(`response-${timestamp}`);
                if (responseDiv) {
                    responseDiv.innerHTML = '<div style="color: #f00;">connection failed - try again</div>';
                }
            });
        }

        function handleNewPattern(pattern, event) {
            if (!pattern.trim()) return;
            
            document.getElementById('input').value = pattern;
            handleSubmit();
        }

        function handleSubmit() {
            const input = document.getElementById('input');
            const coordinate = input.value.trim();
            const history = document.getElementById('history');

            if (!coordinate) return;

            // Hide context controls after submission
            document.getElementById('contextControls').style.display = 'none';

            // Auto-collapse all other open sections
            collapseAllSections();

            // Generate unique ID for this entry
            const entryId = 'entry-' + Date.now();
            
            // Create history entry
            const historyEntry = document.createElement('div');
            historyEntry.className = 'history-entry';
            historyEntry.id = `entry-${entryId}`;
            historyEntry.innerHTML = `
                <div class="coordinate-header">
                    <div class="coordinate-left">
                        <span class="toggle-arrow" id="arrow-${entryId}" onclick="toggleEntry('${entryId}')">▼</span>
                        <span class="coordinate-text" onclick="toggleEntry('${entryId}')">${coordinate}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="share-button" onclick="shareToGallery('${coordinate}')" title="Share to Gallery">☆</span>
                        <span class="trash-icon" style="opacity: 0.6;" onclick="deleteCoordinate('${entryId}')" title="Delete">🗑️</span>
                    </div>
                </div>
                <div class="response-content" id="content-${entryId}">
                    <div class="thinking">potential in formation...</div>
                </div>
            `;
            
            // Add to TOP of history (prepend)
            history.insertBefore(historyEntry, history.firstChild);
            
            // Clear input
            input.value = '';
            
            // Engage with the pattern
            engage(coordinate, 'jump', null, null).then(response => {
                // Remove thinking indicator and add response
                const contentDiv = document.getElementById(`content-${entryId}`);
                const formattedVoice = formatPatternVoice(response.voice);
                
                // Initialize conversation history for this pattern
                patternConversations[coordinate] = [{
                    role: 'pattern',
                    content: response.voice
                }];
                
                const voiceToggleId = `voice-${entryId}`;

                // Extract headline from voice response (first line)
                const lines = response.voice.split('\n');
                const voiceSummary = lines[0].trim() || response.voice.split(' ').slice(0, 6).join(' ') + '...';

                // Extract pattern definitions and voice content
                const fullResponse = response.voice;
                let definitions = '';
                let voiceContent = '';
                let pastDefinitions = false;

                const responseLines = fullResponse.split('\n');
                for (let line of responseLines) {
                    line = line.trim();
                    if (!line) continue;

                    // Skip headline
                    if (line === responseLines[0].trim()) continue;

                    // Pattern definitions
                    if (line.includes(' - the intelligence of') || line.includes(' - where') || line.includes('(lens) - ')) {
                        definitions += line + '\n';
                    }
                    // Everything else is voice content
                    else {
                        pastDefinitions = true;
                        voiceContent += line + '\n';
                    }
                }

                console.log('Definitions:', definitions);
                console.log('Voice content:', voiceContent);

                const formattedDefinitions = formatPatternVoice(definitions);
                const formattedVoiceContent = formatPatternVoice(voiceContent);

                const specToggleId = `spec-${entryId}`;

                // Add the formatted response with spec section and voice toggle
                contentDiv.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <span style="color: #bbb; font-size: 16px; cursor: pointer;" onclick="toggleSpecResponse('${specToggleId}')">▼ Pattern Essence</span>
                    </div>
                    <div id="${specToggleId}" style="margin-bottom: 8px;">
                        ${formattedDefinitions}
                    </div>
                    <div style="border-top: 1px solid #333; margin-bottom: 8px; padding-top: 8px;">
                        <span style="color: #bbb; font-size: 16px; cursor: pointer;" onclick="toggleVoiceResponse('${voiceToggleId}')">▼ ${voiceSummary}</span>
                    </div>
                    <div id="${voiceToggleId}">
                        <div style="padding-bottom: 4px; margin-bottom: 4px; line-height: 1.5;">
                            ${formattedVoiceContent}
                        </div>
                        <div style="display: flex; align-items: center; width: 100%;">
                            <span style="color: #0ff;">>></span>
                            <input type="text" placeholder="Continue exploring..."
                                   onkeypress="if(event.key==='Enter') handleExploration('${coordinate}', this.value, event)"
                                   style="background: #000; color: #0ff; border: none; margin-left: 8px; font-family: 'Courier New', monospace; font-size: 16px; flex: 1;" />
                        </div>
                    </div>
                `;
                
            }).catch(error => {
                const contentDiv = document.getElementById(`content-${entryId}`);
                contentDiv.innerHTML = '<div style="color: #f00;">connection failed - try again</div>';
            });
        }
        // Initialize gallery on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateGalleryDisplay();
        });

    </script>
</body>
</html>